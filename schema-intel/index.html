    <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schema Intelligence</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface2: #222639;
      --surface3: #2a2f45;
      --border: #2e3348;
      --text: #e4e7f1;
      --text2: #9199b4;
      --text3: #636b87;
      --accent: #6c7cf5;
      --accent2: #4fc3f7;
      --trusted: #66bb6a;
      --neutral: #ffa726;
      --dead: #636b87;
      --glow: rgba(108, 124, 245, .15);
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    
    /* Header */
    .header {
      text-align: center;
      padding: 2rem;
      margin-bottom: 2rem;
      background: linear-gradient(135deg, rgba(108, 124, 245, .08), rgba(79, 195, 247, .06));
      border: 1px solid var(--border);
      border-radius: 16px;
    }
    .header h1 { font-size: 2rem; font-weight: 700; margin-bottom: .5rem; }
    .header p { color: var(--text2); }
    
    /* Stats bar */
    .stats {
      display: flex;
      gap: 2rem;
      justify-content: center;
      margin-top: 1rem;
    }
    .stat { text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 600; color: var(--accent); }
    .stat-label { font-size: .75rem; color: var(--text3); text-transform: uppercase; }
    
    /* Search */
    .search-container { margin-bottom: 2rem; }
    .search-bar {
      display: flex;
      align-items: center;
      gap: .75rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: .75rem 1rem;
      transition: border-color .2s;
    }
    .search-bar:focus-within { border-color: var(--accent); }
    .search-bar input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 1rem;
      outline: none;
    }
    .search-bar input::placeholder { color: var(--text3); }
    .search-icon { color: var(--text3); }
    .search-hint { font-size: .75rem; color: var(--text3); margin-top: .5rem; text-align: center; }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: .5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: .5rem;
    }
    .tab {
      padding: .5rem 1rem;
      background: transparent;
      border: none;
      color: var(--text2);
      font-size: .9rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all .2s;
    }
    .tab:hover { color: var(--text); background: var(--surface); }
    .tab.active { color: var(--accent); background: var(--surface2); }
    
    /* Panels */
    .panel { display: none; }
    .panel.active { display: block; }
    
    /* Table cards */
    .table-grid { display: grid; gap: 1rem; }
    .table-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: border-color .2s;
    }
    .table-card:hover { border-color: var(--accent); }
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      cursor: pointer;
      user-select: none;
    }
    .table-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1rem;
      font-weight: 500;
      color: var(--accent2);
    }
    .table-meta {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .table-source {
      font-size: .7rem;
      padding: .2rem .5rem;
      background: var(--surface3);
      border-radius: 4px;
      color: var(--text2);
      text-transform: uppercase;
    }
    .table-stats { font-size: .85rem; color: var(--text3); }
    .quality-dots {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .quality-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .quality-dot.trusted { background: var(--trusted); }
    .quality-dot.neutral { background: var(--neutral); }
    .quality-dot.dead { background: var(--dead); }
    .expand-icon {
      color: var(--text3);
      transition: transform .2s;
    }
    .table-card.expanded .expand-icon { transform: rotate(180deg); }
    
    /* Column list */
    .column-list {
      display: none;
      border-top: 1px solid var(--border);
      max-height: 400px;
      overflow-y: auto;
    }
    .table-card.expanded .column-list { display: block; }
    .column-filter {
      padding: .75rem 1rem;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
    }
    .filter-btn {
      padding: .25rem .75rem;
      background: var(--surface3);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text2);
      font-size: .75rem;
      cursor: pointer;
      transition: all .2s;
    }
    .filter-btn:hover { border-color: var(--accent); color: var(--text); }
    .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    .column-table { width: 100%; border-collapse: collapse; }
    .column-table th {
      text-align: left;
      padding: .5rem 1rem;
      font-size: .7rem;
      text-transform: uppercase;
      color: var(--text3);
      background: var(--surface2);
      position: sticky;
      top: 0;
    }
    .column-table td {
      padding: .5rem 1rem;
      border-top: 1px solid var(--border);
      font-size: .85rem;
    }
    .column-table tr:hover { background: var(--surface2); }
    .col-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: .8rem;
    }
    .col-quality {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
    }
    .col-quality .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }
    .col-quality.trusted .dot { background: var(--trusted); }
    .col-quality.neutral .dot { background: var(--neutral); }
    .col-quality.dead .dot { background: var(--dead); }
    
    /* Joins panel */
    .join-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: .75rem;
    }
    .join-path {
      display: flex;
      align-items: center;
      gap: .5rem;
      flex-wrap: wrap;
    }
    .join-table {
      font-family: 'JetBrains Mono', monospace;
      font-size: .9rem;
      color: var(--accent2);
    }
    .join-arrow { color: var(--text3); }
    .join-col {
      font-size: .8rem;
      color: var(--text2);
    }
    .join-type {
      font-size: .7rem;
      padding: .2rem .5rem;
      background: var(--surface3);
      border-radius: 4px;
      color: var(--neutral);
      margin-left: auto;
    }
    .join-notes {
      font-size: .8rem;
      color: var(--text3);
      margin-top: .5rem;
      font-style: italic;
    }
    
    /* Glossary panel */
    .glossary-table { width: 100%; border-collapse: collapse; }
    .glossary-table th {
      text-align: left;
      padding: .75rem 1rem;
      font-size: .7rem;
      text-transform: uppercase;
      color: var(--text3);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .glossary-table td {
      padding: .75rem 1rem;
      border-bottom: 1px solid var(--border);
    }
    .glossary-term { font-weight: 500; }
    .glossary-tech {
      font-family: 'JetBrains Mono', monospace;
      font-size: .85rem;
      color: var(--accent2);
    }
    
    /* Search results */
    .search-results {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 1.5rem;
      display: none;
    }
    .search-results.active { display: block; }
    .search-results-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      font-weight: 500;
    }
    .search-result {
      padding: .75rem 1.25rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background .2s;
    }
    .search-result:last-child { border-bottom: none; }
    .search-result:hover { background: var(--surface2); }
    .result-table { color: var(--text3); font-size: .8rem; }
    .result-column {
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent2);
    }
    .result-usage { color: var(--text2); font-size: .85rem; }
    
    /* Highlight */
    mark {
      background: rgba(108, 124, 245, .3);
      color: var(--text);
      padding: 0 2px;
      border-radius: 2px;
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text3);
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--text3);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Schema Intelligence</h1>
      <p>Queryable knowledge base for database structure and relationships</p>
      <div class="stats" id="stats"></div>
    </div>
    
    <div class="search-container">
      <div class="search-bar">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" id="search" placeholder="Search tables and columns..." autocomplete="off">
      </div>
      <p class="search-hint">Try: serial_number, modality, case, Id</p>
    </div>
    
    <div class="search-results" id="search-results">
      <div class="search-results-header">Search Results</div>
      <div id="results-list"></div>
    </div>
    
    <div class="tabs">
      <button class="tab active" data-panel="tables">Tables</button>
      <button class="tab" data-panel="joins">Joins</button>
      <button class="tab" data-panel="detected-joins">Detected FKs</button>
      <button class="tab" data-panel="prefixes">ID Prefixes</button>
      <button class="tab" data-panel="glossary">Glossary</button>
    </div>
    
    <div class="panel active" id="tables-panel">
      <div class="table-grid" id="table-grid"></div>
    </div>
    
    <div class="panel" id="joins-panel">
      <div id="joins-list"></div>
    </div>

    <div class="panel" id="detected-joins-panel">
      <p style="color:var(--text2);margin-bottom:1rem;font-size:.9rem;">
        Auto-detected foreign key relationships based on Salesforce ID prefix matching.
        These are inferred - verify before using in queries.
      </p>
      <div class="detected-joins-filter" style="margin-bottom:1rem;">
        <input type="text" id="detected-joins-search" placeholder="Filter by table or column..." 
               style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.5rem 1rem;color:var(--text);width:300px;">
      </div>
      <div id="detected-joins-list"></div>
    </div>

    <div class="panel" id="prefixes-panel">
      <p style="color:var(--text2);margin-bottom:1rem;font-size:.9rem;">
        Salesforce IDs use a 3-character prefix to identify the object type.
        Use this to decode IDs and find their source tables.
      </p>
      <div class="prefixes-filter" style="margin-bottom:1rem;">
        <input type="text" id="prefix-search" placeholder="Search prefix or table..." 
               style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.5rem 1rem;color:var(--text);width:300px;">
      </div>
      <table class="glossary-table" id="prefix-table">
        <thead>
          <tr><th>Prefix</th><th>Table(s)</th></tr>
        </thead>
        <tbody id="prefix-body"></tbody>
      </table>
    </div>
    
    <div class="panel" id="glossary-panel">
      <table class="glossary-table" id="glossary-table">
        <thead>
          <tr><th>Term</th><th>Technical</th><th>Description</th></tr>
        </thead>
        <tbody id="glossary-body"></tbody>
      </table>
    </div>
  </div>
  
  <script>
    let DATA = null;
    
    // Load data
    async function loadData() {
      try {
        const response = await fetch('data.json');
        DATA = await response.json();
        renderStats();
        renderTables();
        renderJoins();
        renderDetectedJoins();
        renderPrefixes();
        renderGlossary();
      } catch (e) {
        console.error('Failed to load data:', e);
        document.getElementById('table-grid').innerHTML = 
          '<div class="empty-state">Failed to load data. Run: python3 scripts/build_json.py</div>';
      }
    }
    
    // Render stats
    function renderStats() {
      document.getElementById('stats').innerHTML = `
        <div class="stat">
          <div class="stat-value">${DATA.stats.table_count}</div>
          <div class="stat-label">Tables</div>
        </div>
        <div class="stat">
          <div class="stat-value">${DATA.stats.column_count.toLocaleString()}</div>
          <div class="stat-label">Columns</div>
        </div>
        <div class="stat">
          <div class="stat-value">${DATA.stats.detected_join_count || 0}</div>
          <div class="stat-label">FK Links</div>
        </div>
        <div class="stat">
          <div class="stat-value">${DATA.stats.prefix_count || 0}</div>
          <div class="stat-label">ID Prefixes</div>
        </div>
      `;
    }
    
    // Render tables
    function renderTables() {
      const grid = document.getElementById('table-grid');
      grid.innerHTML = DATA.tables.map(table => `
        <div class="table-card" data-table="${table.name}">
          <div class="table-header" onclick="toggleTable('${table.name}')">
            <div>
              <span class="table-name">${table.name}</span>
              <span class="table-source">${table.source || 'unknown'}</span>
            </div>
            <div class="table-meta">
              <div class="quality-dots" title="Trusted / Neutral / Dead">
                <span class="quality-dot trusted"></span>
                <span style="font-size:.7rem;color:var(--text3)">${table.quality_summary?.trusted || 0}</span>
                <span class="quality-dot neutral"></span>
                <span style="font-size:.7rem;color:var(--text3)">${table.quality_summary?.neutral || 0}</span>
                <span class="quality-dot dead"></span>
                <span style="font-size:.7rem;color:var(--text3)">${table.quality_summary?.dead || 0}</span>
              </div>
              <span class="table-stats">${table.column_count} cols</span>
              <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m6 9 6 6 6-6"/>
              </svg>
            </div>
          </div>
          <div class="column-list">
            <div class="column-filter">
              <button class="filter-btn active" data-filter="all" onclick="filterColumns('${table.name}', 'all', this)">All</button>
              <button class="filter-btn" data-filter="trusted" onclick="filterColumns('${table.name}', 'trusted', this)">Trusted</button>
              <button class="filter-btn" data-filter="neutral" onclick="filterColumns('${table.name}', 'neutral', this)">Neutral</button>
              <button class="filter-btn" data-filter="dead" onclick="filterColumns('${table.name}', 'dead', this)">Dead</button>
            </div>
            <table class="column-table">
              <thead>
                <tr><th>Column</th><th>Usage</th><th>Quality</th></tr>
              </thead>
              <tbody>
                ${table.columns.map(col => `
                  <tr data-quality="${col.quality}">
                    <td class="col-name">${col.name}</td>
                    <td>${col.usage_pct.toFixed(1)}%</td>
                    <td><span class="col-quality ${col.quality}"><span class="dot"></span>${col.quality}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `).join('');
    }
    
    // Toggle table expansion
    function toggleTable(name) {
      const card = document.querySelector(`.table-card[data-table="${name}"]`);
      card.classList.toggle('expanded');
    }
    
    // Filter columns by quality
    function filterColumns(tableName, filter, btn) {
      const card = document.querySelector(`.table-card[data-table="${tableName}"]`);
      const rows = card.querySelectorAll('.column-table tbody tr');
      const buttons = card.querySelectorAll('.filter-btn');
      
      buttons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      rows.forEach(row => {
        if (filter === 'all' || row.dataset.quality === filter) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    // Render joins
    function renderJoins() {
      const list = document.getElementById('joins-list');
      if (!DATA.joins || DATA.joins.length === 0) {
        list.innerHTML = '<div class="empty-state">No join definitions found</div>';
        return;
      }
      
      list.innerHTML = DATA.joins.map(join => `
        <div class="join-card">
          <div class="join-path">
            <span class="join-table">${join.from_table}</span>
            <span class="join-arrow">→</span>
            <span class="join-table">${join.to_table}</span>
            ${join.join_column ? `<span class="join-col">on ${join.join_column}</span>` : ''}
            ${join.join_type ? `<span class="join-type">${join.join_type}</span>` : ''}
          </div>
          ${join.notes ? `<div class="join-notes">${join.notes}</div>` : ''}
        </div>
      `).join('');
    }
    
    // Render glossary
    function renderGlossary() {
      const body = document.getElementById('glossary-body');
      if (!DATA.glossary || DATA.glossary.length === 0) {
        body.innerHTML = '<tr><td colspan="3" class="empty-state">No glossary entries</td></tr>';
        return;
      }
      
      body.innerHTML = DATA.glossary.map(entry => `
        <tr>
          <td class="glossary-term">${entry.term}</td>
          <td class="glossary-tech">${entry.technical}</td>
          <td>${entry.description}</td>
        </tr>
      `).join('');
    }

    // Render ID prefixes
    function renderPrefixes() {
      const body = document.getElementById('prefix-body');
      if (!DATA.id_prefixes || DATA.id_prefixes.length === 0) {
        body.innerHTML = '<tr><td colspan="2" class="empty-state">No ID prefixes found</td></tr>';
        return;
      }
      
      body.innerHTML = DATA.id_prefixes.map(p => `
        <tr data-prefix="${p.prefix}" data-tables="${p.tables.join(' ')}">
          <td><code style="background:var(--surface3);padding:.2rem .5rem;border-radius:4px;color:var(--accent2);">${p.prefix}</code></td>
          <td>${p.tables.map(t => `<code style="background:var(--surface2);padding:.2rem .4rem;border-radius:4px;margin-right:.3rem;font-size:.85rem;">${t}</code>`).join('')}</td>
        </tr>
      `).join('');

      // Add search handler
      document.getElementById('prefix-search').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('#prefix-body tr').forEach(row => {
          const prefix = row.dataset.prefix.toLowerCase();
          const tables = row.dataset.tables.toLowerCase();
          row.style.display = (prefix.includes(query) || tables.includes(query)) ? '' : 'none';
        });
      });
    }

    // Render detected joins
    function renderDetectedJoins() {
      const list = document.getElementById('detected-joins-list');
      if (!DATA.detected_joins || DATA.detected_joins.length === 0) {
        list.innerHTML = '<div class="empty-state">No FK relationships detected. Run: python3 scripts/build_references.py</div>';
        return;
      }

      // Group by from_table
      const byTable = {};
      DATA.detected_joins.forEach(j => {
        if (!byTable[j.from_table]) byTable[j.from_table] = [];
        byTable[j.from_table].push(j);
      });

      list.innerHTML = Object.entries(byTable).map(([table, joins]) => `
        <div class="join-card" data-table="${table}">
          <div class="table-name" style="margin-bottom:.75rem;font-size:1rem;">${table}</div>
          <div style="display:flex;flex-wrap:wrap;gap:.5rem;">
            ${joins.map(j => `
              <div style="display:flex;align-items:center;gap:.3rem;background:var(--surface2);padding:.3rem .6rem;border-radius:6px;font-size:.8rem;">
                <code style="color:var(--text2);">${j.from_column}</code>
                <span style="color:var(--text3);">→</span>
                <code style="color:var(--accent2);">${j.to_table}</code>
                <span style="color:var(--text3);font-size:.7rem;opacity:.7;">(${j.prefix})</span>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');

      // Add search handler
      document.getElementById('detected-joins-search').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('#detected-joins-list .join-card').forEach(card => {
          const table = card.dataset.table.toLowerCase();
          const content = card.textContent.toLowerCase();
          card.style.display = (table.includes(query) || content.includes(query)) ? '' : 'none';
        });
      });
    }
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.panel}-panel`).classList.add('active');
      });
    });
    
    // Search
    const searchInput = document.getElementById('search');
    const searchResults = document.getElementById('search-results');
    const resultsList = document.getElementById('results-list');
    
    searchInput.addEventListener('input', debounce(handleSearch, 200));
    
    function handleSearch() {
      const query = searchInput.value.toLowerCase().trim();
      
      if (!query) {
        searchResults.classList.remove('active');
        return;
      }
      
      const results = [];
      
      // Search columns
      DATA.tables.forEach(table => {
        table.columns.forEach(col => {
          if (col.name.toLowerCase().includes(query)) {
            results.push({
              type: 'column',
              table: table.name,
              column: col.name,
              usage: col.usage_pct,
              quality: col.quality,
            });
          }
        });
      });
      
      // Search table names
      DATA.tables.forEach(table => {
        if (table.name.toLowerCase().includes(query)) {
          results.push({
            type: 'table',
            table: table.name,
            columns: table.column_count,
          });
        }
      });
      
      // Limit results
      const limited = results.slice(0, 50);
      
      if (limited.length === 0) {
        resultsList.innerHTML = '<div class="search-result">No results found</div>';
      } else {
        resultsList.innerHTML = limited.map(r => {
          if (r.type === 'column') {
            return `
              <div class="search-result" onclick="jumpToColumn('${r.table}', '${r.column}')">
                <span class="result-table">${r.table}</span>
                <span class="result-column">${highlightMatch(r.column, query)}</span>
                <span class="result-usage">${r.usage.toFixed(1)}% • ${r.quality}</span>
              </div>
            `;
          } else {
            return `
              <div class="search-result" onclick="jumpToTable('${r.table}')">
                <span class="result-column">${highlightMatch(r.table, query)}</span>
                <span class="result-usage">${r.columns} columns</span>
              </div>
            `;
          }
        }).join('');
      }
      
      searchResults.classList.add('active');
    }
    
    function highlightMatch(text, query) {
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }
    
    function jumpToTable(name) {
      searchResults.classList.remove('active');
      searchInput.value = '';
      
      // Switch to tables tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelector('.tab[data-panel="tables"]').classList.add('active');
      document.getElementById('tables-panel').classList.add('active');
      
      // Expand and scroll to table
      const card = document.querySelector(`.table-card[data-table="${name}"]`);
      if (card) {
        card.classList.add('expanded');
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    
    function jumpToColumn(tableName, columnName) {
      jumpToTable(tableName);
    }
    
    function debounce(fn, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), delay);
      };
    }
    
    // Keyboard shortcut: / to focus search
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== searchInput) {
        e.preventDefault();
        searchInput.focus();
      }
      if (e.key === 'Escape') {
        searchInput.blur();
        searchResults.classList.remove('active');
      }
    });
    
    // Initialize
    loadData();
  </script>
</body>
</html>
